name: Deploy backend to EC2

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set image name (lowercase)
        id: image
        run: echo "name=ghcr.io/$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')/fright-finds-backend:latest" >> $GITHUB_OUTPUT

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image to GHCR
        run: |
          docker build -t ${{ steps.image.outputs.name }} ./backend
          docker push ${{ steps.image.outputs.name }}

      - name: Check EC2 connectivity
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          echo "Testing connectivity to $EC2_HOST port 22..."
          nc -zv -w 10 "$EC2_HOST" 22 && echo "Port 22 is OPEN" || echo "Port 22 is CLOSED or filtered"

      - name: Deploy on EC2 via SSH
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
          GHCR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GHCR_USER: ${{ github.actor }}
          IMAGE_NAME: ${{ steps.image.outputs.name }}
        run: |
          # Write SSH key to file
          echo "$EC2_SSH_KEY" | tr -d '\r' > /tmp/ec2_key.pem
          chmod 600 /tmp/ec2_key.pem
          # Debug: verify key format
          head -1 /tmp/ec2_key.pem

          # Deploy via SSH
          ssh -v \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=60 \
              -o ServerAliveInterval=10 \
              -o ServerAliveCountMax=6 \
              -p 22 \
              -i /tmp/ec2_key.pem \
              "$EC2_USER@$EC2_HOST" "echo connected" || true

          # Deploy via SSH
          ssh -o StrictHostKeyChecking=no \
              -o ConnectTimeout=60 \
              -o ServerAliveInterval=10 \
              -o ServerAliveCountMax=6 \
              -p 22 \
              -i /tmp/ec2_key.pem \
              "$EC2_USER@$EC2_HOST" \
              "
                echo '$GHCR_TOKEN' | docker login ghcr.io -u '$GHCR_USER' --password-stdin
                docker pull $IMAGE_NAME
                if [ \$(docker ps -aq -f name=fright-backend) ]; then
                  docker stop fright-backend
                  docker rm fright-backend
                fi
                docker run -d \
                  --name fright-backend \
                  --restart unless-stopped \
                  -p 3000:3000 \
                  $IMAGE_NAME
                docker image prune -f
              "

          # Cleanup key
          rm -f /tmp/ec2_key.pem
